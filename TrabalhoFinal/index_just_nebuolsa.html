<!DOCTYPE html>
<html>

<head>
  <title>Trabalho Final</title>
  <meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="css/styles.css" />
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>


<body>

  <!-- <script src="three.min.js"></script> -->
  <script src="three.js-master/build/three.min.js"></script>
  <script src="postprocessing.min.js"></script>

  <script type="module">

    var scene, camera, cloudParticles = [], composer;
    var container;
    var renderer;
    var mouseX = 0, mouseY = 0;
    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2;
    var cloudGeo, cloudMaterial, composer;

    import * as THREE from './three.js-master/build/three.module.js';
    import { DDSLoader } from './three.js-master/examples/jsm/loaders/DDSLoader.js';
    import { MTLLoader } from './three.js-master/examples/jsm/loaders/MTLLoader.js';
    import { OBJLoader } from './three.js-master/examples/jsm/loaders/OBJLoader.js';


    function init() {

      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
      camera.position.z = 1;
      camera.rotation.x = 1.16;
      camera.rotation.y = -0.12;
      camera.rotation.z = 0.27;

      createBackground();
      //createObject();

    }

    function createBackground() {
      let ambient = new THREE.AmbientLight(0x836FFF);
      scene.add(ambient);

      let directionalLight = new THREE.DirectionalLight(0xff8c19);
      directionalLight.position.set(0, 0, 1);
      scene.add(directionalLight);

      let orangeLight = new THREE.PointLight(0xcc6600, 50, 450, 1.7);
      orangeLight.position.set(200, 300, 100);
      scene.add(orangeLight);
      let redLight = new THREE.PointLight(0xd8547e, 50, 450, 1.7);
      redLight.position.set(100, 300, 100);
      scene.add(redLight);
      let blueLight = new THREE.PointLight(0x3677ac, 50, 450, 1.7);
      blueLight.position.set(300, 300, 200);
      scene.add(blueLight);

      renderer = new THREE.WebGLRenderer();
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      scene.fog = new THREE.FogExp2(0x03544e, 0.001);
      renderer.setClearColor(scene.fog.color);
      document.body.appendChild(renderer.domElement);

      let loader = new THREE.TextureLoader();
      loader.load("models/images/smoke.png", function (texture) {
        cloudGeo = new THREE.PlaneBufferGeometry(500, 500);
        cloudMaterial = new THREE.MeshLambertMaterial({
          map: texture,
          transparent: true
        });

        for (let p = 0; p < 50; p++) {
          let cloud = new THREE.Mesh(cloudGeo, cloudMaterial);
          cloud.position.set(
            Math.random() * 800 - 400,
            500,
            Math.random() * 500 - 500
          );
          cloud.rotation.x = 1.16;
          cloud.rotation.y = -0.12;
          cloud.rotation.z = Math.random() * 2 * Math.PI;
          cloud.material.opacity = 0.55;
          cloudParticles.push(cloud);
          scene.add(cloud);
        }
      });
      loader.load("models/images/stars.jpg", function (texture) {

        const textureEffect = new POSTPROCESSING.TextureEffect({
          blendFunction: POSTPROCESSING.BlendFunction.COLOR_DODGE,
          texture: texture
        });
        textureEffect.blendMode.opacity.value = 0.2;

        const bloomEffect = new POSTPROCESSING.BloomEffect({
          blendFunction: POSTPROCESSING.BlendFunction.COLOR_DODGE,
          kernelSize: POSTPROCESSING.KernelSize.SMALL,
          useLuminanceFilter: true,
          luminanceThreshold: 0.3,
          luminanceSmoothing: 0.75
        });
        bloomEffect.blendMode.opacity.value = 1.5;

        let effectPass = new POSTPROCESSING.EffectPass(
          camera,
          bloomEffect,
          textureEffect
        );
        effectPass.renderToScreen = true;

        composer = new POSTPROCESSING.EffectComposer(renderer);
        composer.addPass(new POSTPROCESSING.RenderPass(scene, camera));
        composer.addPass(effectPass);

        window.addEventListener("resize", onWindowResize, false);


        // Object
        container = document.createElement('div');
        document.body.appendChild(container);

        var gridHelper = new THREE.GridHelper(100, 100);
        gridHelper.position.x = 0;
        gridHelper.position.y = 0;
        scene.add(gridHelper);

        var onProgress = function (xhr) {
          if (xhr.lengthComputable) {
            var percentComplete = xhr.loaded / xhr.total * 100;
            console.log(Math.round(percentComplete, 2) + '% downloaded');
          }
        };
        var onError = function () { };

        var manager = new THREE.LoadingManager();
        manager.addHandler(/\.dds$/i, new DDSLoader());


        new MTLLoader(manager)
        .setPath('models/objects/relief/source/Kinderspital_C/')
        .load('Kinderspital_C.mtl', function (materials) {

          materials.preload();

          new OBJLoader(manager)
            .setMaterials(materials)
            .setPath('models/objects/relief/source/Kinderspital_C/')
            .load('Kinderspital_C.obj', function (object) {

              THREE.Object3D.DefaultUp.set(0.0, 0.0, 1.0);

              object.rotateZ(THREE.Math.degToRad(-90));
              object.rotateY(THREE.Math.degToRad(-90));
              object.position.y = -20;
              object.scale.x = 0.05;
              object.scale.y = 0.05;
           

              //object.rotateX(THREE.Math.degToRad(90));


              scene.add(object);

            }, onProgress, onError);

        });



        render();









      });

    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onDocumentMouseMove(event) {

      mouseX = (event.clientX - windowHalfX) / 2;
      mouseY = (event.clientY - windowHalfY) / 2;

    }


    function render() {
      cloudParticles.forEach(p => {
        p.rotation.z -= 0.01;
      });
      
      composer.render(0.1);


      requestAnimationFrame(render);
    }

    init();


  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <title>three.js webgl - OBJLoader + MTLLoader</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        * {
            margin: 0px;
            padding: 0px;
        }


        .info {
            position: absolute;

            width: 100%;
            z-index: 100;
            display: block;

            color: red;
            font-size: 25px;
            text-align: center;
        }

        .top1 {
            top: 700px;
        }

        .top2 {
            top: 750px;
        }
    </style>
</head>

<body>

    <div class="info top1">Nome: Thiago Heron</div>
    <div class="info top2">Contato: thiagoheronavila@gmail.com</div>


    <script src="three.js-master/build/three.min.js"></script>
    <script src="postprocessing.min.js"></script>


    <script type="module">

        // Imports
        import * as THREE from './three.js-master/build/three.module.js';
        import { DDSLoader } from './three.js-master/examples/jsm/loaders/DDSLoader.js';
        import { MTLLoader } from './three.js-master/examples/jsm/loaders/MTLLoader.js';
        import { OBJLoader } from './three.js-master/examples/jsm/loaders/OBJLoader.js';
        import { TextureLoader } from './three.js-master/src/loaders/TextureLoader.js';
        import { GLTFLoader } from './three.js-master/examples/jsm/loaders/GLTFLoader.js';

        var container;
        var camera, scene, renderer;

        var loader;
        var cloudGeo, cloudMaterial;
        var cloudParticles = [];
        var composer;

        var images = []

        var raycaster, mouse;
        var meshText;

        init();
        animate();


        function init() {

            container = document.createElement('div');
            document.body.appendChild(container);

            // Scene
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x2085C4, 0.0001);

            // Camera
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
            camera.position.x = 0;
            camera.position.y = 50;
            camera.position.z = -5500;
            camera.lookAt(scene.position);

            // Lights
            var ambientLight = new THREE.AmbientLight(0x0000FF, 1);
            scene.add(ambientLight);

            var pointLight = new THREE.PointLight(0xffffff, 1);
            camera.add(pointLight);

            scene.add(camera);


            // Objects
            createClouds();
            createObjectGLTF(
                'models/objects/computer_1/scene.gltf',
                [0, -10, 0],
                [5, 5, 5],
                [0, 0, 0]
            );
            createImage('models/images/elixirai.jpg', [-200, 80, -1050], [30, 40, 20]);







            // Mouse
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2()
            document.addEventListener('mousemove', onMouseMove, false);
            document.addEventListener('mousedown', onMouseDown, false);


            // Render
            renderer = new THREE.WebGLRenderer();
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(scene.fog.color);
            document.body.appendChild(renderer.domElement);
            container.appendChild(renderer.domElement);
            window.addEventListener('resize', onWindowResize, false);
        }







        // Auxiliares
        function onWindowResize() {

            let windowHalfX = window.innerWidth / 2;
            let windowHalfY = window.innerHeight / 2;

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseMove(event) {
            event.preventDefault();
            mouse.x = ((event.clientX / window.innerWidth) * 2 - 1) * 100;
            mouse.y = (-(event.clientY / window.innerHeight) * 2 + 1) * 100;
            console.log("Mouse - X: ", mouse.x, " - Y: ", mouse.y);
        }

        function onMouseDown(event) {
            console.log("X:" + mouse.x * 100 + " - Y " + mouse.y * 100);
        }

        // Objects

        function createGridHelper() {

            // Grid Helper
            var gridHelper = new THREE.GridHelper(100, 20);
            gridHelper.position.x = 0;
            gridHelper.position.y = 0;
            scene.add(gridHelper);
        }

        function createClouds() {
            // Texture
            loader = new THREE.TextureLoader();
            loader.load("models/images/smoke.png", function (texture) {

                cloudGeo = new THREE.PlaneBufferGeometry(500, 500);
                cloudMaterial = new THREE.MeshLambertMaterial({
                    map: texture,
                    transparent: true
                });
                for (let p = 0; p < 10; p++) {
                    let cloud = new THREE.Mesh(cloudGeo, cloudMaterial);
                    cloud.position.set(
                        Math.random() * 700 - 400,
                        -70,
                        Math.random() * 500 - 500
                    );

                    cloud.material.opacity = 1;
                    cloudParticles.push(cloud);
                    scene.add(cloud);
                }

            });



            let directionalLight = new THREE.DirectionalLight(0x836FFF, 1.7);
            directionalLight.position.set(0, 0, 1);
            scene.add(directionalLight);

            let orangeLight = new THREE.PointLight(0xcc6600, 10, 450, 1.7);
            orangeLight.position.set(200, 300, 100);
            scene.add(orangeLight);

            let redLight = new THREE.PointLight(0xd8547e, 10, 450, 1.7);
            redLight.position.set(100, 300, 100);
            scene.add(redLight);

            let blueLight = new THREE.PointLight(0x3677ac, 10, 450, 1.7);
            blueLight.position.set(300, 300, 200);
            scene.add(blueLight);


            loader.load("models/images/stars.jpg", function (texture) {

                const textureEffect = new POSTPROCESSING.TextureEffect({
                    blendFunction: POSTPROCESSING.BlendFunction.COLOR_DODGE,
                    texture: texture
                });
                textureEffect.blendMode.opacity.value = 0.2;

                const bloomEffect = new POSTPROCESSING.BloomEffect({
                    blendFunction: POSTPROCESSING.BlendFunction.COLOR_DODGE,
                    kernelSize: POSTPROCESSING.KernelSize.SMALL,
                    useLuminanceFilter: true,
                    luminanceThreshold: 0.3,
                    luminanceSmoothing: 0.75
                });
                bloomEffect.blendMode.opacity.value = 1.5;

                let effectPass = new POSTPROCESSING.EffectPass(
                    camera,
                    bloomEffect,
                    textureEffect
                );
                effectPass.renderToScreen = true;

                composer = new POSTPROCESSING.EffectComposer(renderer);
                composer.addPass(new POSTPROCESSING.RenderPass(scene, camera));
                composer.addPass(effectPass);
            });
        }

        function createObjectOBJ() {
            var onProgress = function (xhr) {
                if (xhr.lengthComputable) {
                    var percentComplete = xhr.loaded / xhr.total * 100;
                    console.log(Math.round(percentComplete, 2) + '% downloaded');
                }
            };
            var onError = function () { };

            var manager = new THREE.LoadingManager();
            manager.addHandler(/\.dds$/i, new DDSLoader());
            new MTLLoader(manager)
                .setPath('models/objects/relief/source/Kinderspital_C/')
                .load('Kinderspital_C.mtl', function (materials) {

                    materials.preload();

                    new OBJLoader(manager)
                        .setMaterials(materials)
                        .setPath('models/objects/relief/source/Kinderspital_C/')
                        .load('Kinderspital_C.obj', function (object) {

                            object.rotateZ(THREE.Math.degToRad(-90));
                            object.rotateY(THREE.Math.degToRad(-90));
                            object.position.y = -25;


                            scene.add(object);

                        }, onProgress, onError);

                });
        }

        function createObjectGLTF(path, positions, scales, rotates) {
            var loader = new GLTFLoader();
            loader.load(path, handle_load);
            var mesh;
            function handle_load(gltf) {

                console.log(gltf);
                mesh = gltf.scene;
                mesh.children[0].material = new THREE.MeshLambertMaterial();
                mesh.position.x = positions[0];
                mesh.position.y = positions[1];
                mesh.position.z = positions[2];
                mesh.scale.x = scales[0];
                mesh.scale.y = scales[1];
                mesh.scale.z = scales[2];
                mesh.rotateX(THREE.Math.degToRad(rotates[0]));
                mesh.rotateY(THREE.Math.degToRad(rotates[1]));
                mesh.rotateZ(THREE.Math.degToRad(rotates[2]));
                scene.add(mesh);
            }



        }

        function createImage(path, positions, sizes) {

            var texture = new THREE.TextureLoader().load(path);
            //var geometry = new THREE.BoxBufferGeometry(sizes[0], sizes[1], sizes[2]);
            var geometry = new THREE.SphereGeometry( 39, 32, 32 );
            var material = new THREE.MeshBasicMaterial({ map: texture });

            //var geometry = new THREE.PlaneGeometry( 50, 50, 1 );
            //var material = new THREE.MeshBasicMaterial( {map: texture} );

            var meshImage = new THREE.Mesh(geometry, material);
            meshImage.position.x = positions[0];
            meshImage.position.y = positions[1];
            meshImage.position.z = positions[2];
            console.log(texture, geometry, material);
            images.push(meshImage);
            scene.add(meshImage);
        }



        function animate() {

            requestAnimationFrame(animate);
            render();

        }

        function render() {



            if (camera.position.z > -550) {
                camera.position.z -= 5;
                cloudParticles.forEach(p => {
                    p.rotation.z -= 0.01;
                });
            } else {
                camera.position.z = -550;
                scene.fog = new THREE.FogExp2(0x00000, 0.0001);
                renderer.setClearColor(scene.fog.color);
            }

            if (composer != undefined) {
                composer.render(1);
            }

            renderer.render(scene, camera);


        }

    </script>

</body>

</html>